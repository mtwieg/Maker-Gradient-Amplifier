Version 4
SHEET 1 3388 1808
WIRE -384 -1120 -1136 -1120
WIRE 768 -1120 -384 -1120
WIRE 400 -912 400 -928
WIRE 528 -912 528 -928
WIRE 640 -912 640 -928
WIRE 400 -704 400 -720
WIRE 528 -704 528 -720
WIRE 640 -704 640 -720
WIRE -1136 -544 -1136 -1120
WIRE -384 -544 -384 -1120
WIRE -384 -544 -1136 -544
WIRE 768 -544 768 -1120
WIRE 768 -544 -384 -544
WIRE -384 -512 -384 -544
WIRE -1232 -384 -1328 -384
WIRE -1328 -336 -1328 -384
WIRE -448 -224 -496 -224
WIRE -320 -224 -368 -224
WIRE -304 -224 -320 -224
WIRE -496 -128 -496 -224
WIRE -432 -128 -496 -128
WIRE -304 -128 -304 -224
WIRE -304 -128 -368 -128
WIRE -928 -112 -944 -112
WIRE 624 -112 528 -112
WIRE 752 -112 704 -112
WIRE 832 -112 752 -112
WIRE 1088 -112 832 -112
WIRE 1184 -112 1088 -112
WIRE 256 -96 224 -96
WIRE 1184 -80 1184 -112
WIRE 528 -64 528 -112
WIRE 1088 -64 1088 -112
WIRE -1248 -48 -1328 -48
WIRE -1168 -48 -1248 -48
WIRE -1136 -48 -1168 -48
WIRE -944 -48 -944 -112
WIRE -656 -48 -944 -48
WIRE -496 -48 -496 -128
WIRE -496 -48 -512 -48
WIRE -480 -48 -496 -48
WIRE -368 -48 -400 -48
WIRE -304 -48 -304 -128
WIRE -128 -48 -128 -144
WIRE -128 -48 -224 -48
WIRE -112 -48 -128 -48
WIRE -32 -48 -32 -144
WIRE 224 -48 224 -96
WIRE 752 -48 752 -112
WIRE -1248 -16 -1248 -48
WIRE 832 -16 832 -32
WIRE -1328 0 -1328 -48
WIRE -944 0 -944 -48
WIRE -1168 16 -1168 -48
WIRE 1088 32 1088 16
WIRE 1184 32 1184 -16
WIRE 1184 32 1088 32
WIRE -656 48 -656 -48
WIRE -608 48 -656 48
WIRE -496 48 -496 -48
WIRE -496 48 -528 48
WIRE -432 48 -496 48
WIRE -304 64 -304 -48
WIRE -304 64 -368 64
WIRE -432 80 -448 80
WIRE -448 96 -448 80
WIRE -1328 112 -1328 80
WIRE -1248 112 -1248 64
WIRE -944 112 -944 80
WIRE 528 128 528 16
WIRE 752 128 752 16
WIRE 752 128 528 128
WIRE 832 128 832 48
WIRE 832 128 752 128
WIRE 1088 128 1088 112
WIRE 1088 128 832 128
WIRE 528 208 528 128
WIRE -336 240 -336 224
WIRE -336 240 -400 240
WIRE -400 256 -400 240
WIRE -336 272 -336 240
FLAG 528 208 0
FLAG -400 32 5V
FLAG -400 96 -5V
FLAG 48 -48 U
FLAG 256 -96 Duty
FLAG -1328 112 0
FLAG -1248 112 0
FLAG -1136 -48 Y
FLAG -944 112 0
FLAG -336 144 5V
FLAG -336 352 -5V
FLAG -1328 -256 0
FLAG 272 -800 K
FLAG 272 -720 0
FLAG -32 -144 Loopin
FLAG -128 -144 Loopout
FLAG -400 256 0
FLAG 400 -832 0
FLAG 400 -928 C3_F
FLAG 528 -832 0
FLAG 528 -928 C2_F
FLAG 640 -832 0
FLAG 640 -928 C1_F
FLAG 400 -624 0
FLAG 400 -720 R3_ohms
FLAG 528 -624 0
FLAG 528 -720 R2_ohms
FLAG 640 -624 0
FLAG 640 -720 R1_ohms
FLAG -1168 80 0
FLAG -320 -224 t3out
FLAG -448 96 0
FLAG 224 32 0
FLAG -1232 -384 Ref
FLAG -928 -112 E
FLAG -384 -512 0
SYMBOL ind2 1072 -80 R0
SYMATTR InstName L1
SYMATTR Value {LG}
SYMATTR Type ind
SYMBOL res 1072 16 R0
SYMATTR InstName R1
SYMATTR Value {RG}
SYMBOL bv 528 -80 R0
WINDOW 3 -57 -96 Left 2
SYMATTR Value V=absdelay((2*(V(Duty)-0.5)*VM*Nph),pwm_delay)
SYMATTR InstName B1
SYMBOL Opamps\\UniversalOpamp2 -400 64 R0
SYMATTR InstName U2
SYMATTR Value2 Avol=10Meg GBW=10Meg Slew=10Meg
SYMBOL cap -304 -64 R90
WINDOW 0 0 32 Invisible 2
WINDOW 3 -26 34 VTop 2
SYMATTR InstName C4
SYMATTR Value {C1}
SYMBOL cap -512 -64 R90
WINDOW 0 0 32 Invisible 2
WINDOW 3 -32 30 VTop 2
SYMATTR InstName C5
SYMATTR Value {C3}
SYMBOL cap -368 -144 R90
WINDOW 0 0 32 Invisible 2
WINDOW 3 -33 23 VTop 2
SYMATTR InstName C6
SYMATTR Value {C2}
SYMBOL res -512 32 R90
WINDOW 0 0 56 Invisible 2
WINDOW 3 -29 54 VTop 2
SYMATTR InstName R6
SYMATTR Value {R1}
SYMBOL res -384 -64 R90
WINDOW 0 0 56 Invisible 2
WINDOW 3 -35 64 VTop 2
SYMATTR InstName R7
SYMATTR Value {R2}
SYMBOL res -560 -64 R90
WINDOW 0 0 56 Invisible 2
WINDOW 3 -30 57 VTop 2
SYMATTR InstName R8
SYMATTR Value {R3}
SYMBOL res -352 -240 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R9
SYMATTR Value 1000Meg
SYMBOL bi2 -1328 0 R0
WINDOW 3 -151 82 Left 2
SYMATTR Value I=I(L1)*Iratio
SYMATTR InstName B5
SYMBOL res -1264 -32 R0
SYMATTR InstName R10
SYMATTR Value 62
SYMBOL bv -944 -16 R0
WINDOW 3 8 100 Left 2
SYMATTR Value V=-(1*V(Ref)-1*V(Y))
SYMATTR InstName B3
SYMBOL voltage -336 128 R0
WINDOW 3 24 44 Left 2
WINDOW 123 24 124 Left 2
WINDOW 39 0 0 Left 2
SYMATTR Value 5
SYMATTR InstName V1
SYMBOL voltage -336 256 R0
WINDOW 3 24 44 Left 2
WINDOW 123 24 124 Left 2
WINDOW 39 0 0 Left 2
SYMATTR Value 5
SYMATTR InstName V2
SYMBOL voltage -1328 -352 R0
WINDOW 123 -117 130 Left 2
WINDOW 39 0 0 Left 2
SYMATTR Value2 AC {if(MODE,1,0)}
SYMATTR InstName V3
SYMATTR Value PULSE(0 1 50u 100u 100u 500u 1m)
SYMBOL bv 224 -64 R0
WINDOW 3 -92 -64 Left 2
SYMATTR Value V=(V(U)/Vramp+0.5)
SYMATTR InstName B4
SYMBOL bv 272 -816 R0
SYMATTR InstName B6
SYMATTR Value V={K}
SYMBOL voltage -16 -48 R90
WINDOW 123 68 -38 VRight 2
WINDOW 39 0 0 Left 2
SYMATTR Value2 AC {if(MODE,0,1)}
SYMATTR InstName V4
SYMATTR Value 0
SYMBOL res 64 -64 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R11
SYMATTR Value 1
SYMBOL bv 400 -928 R0
WINDOW 3 -100 93 Invisible 2
SYMATTR Value V={C3}
SYMATTR InstName B7
SYMBOL bv 528 -928 R0
WINDOW 3 -100 93 Invisible 2
SYMATTR Value V={C2}
SYMATTR InstName B8
SYMBOL bv 640 -928 R0
WINDOW 3 -100 93 Invisible 2
SYMATTR Value V={C1}
SYMATTR InstName B9
SYMBOL bv 400 -720 R0
WINDOW 3 -100 93 Invisible 2
SYMATTR Value V={R3}
SYMATTR InstName B10
SYMBOL bv 528 -720 R0
WINDOW 3 -100 93 Invisible 2
SYMATTR Value V={R2}
SYMATTR InstName B11
SYMBOL bv 640 -720 R0
WINDOW 3 -100 93 Invisible 2
SYMATTR Value V={R1}
SYMATTR InstName B12
SYMBOL ind2 608 -96 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName L2
SYMATTR Value 40µ
SYMATTR Type ind
SYMATTR SpiceLine Rser=10m
SYMBOL cap 736 -48 R0
SYMATTR InstName C7
SYMATTR Value 25n
SYMBOL cap 816 -16 R0
SYMATTR InstName C8
SYMATTR Value 100n
SYMBOL cap -1184 16 R0
SYMATTR InstName C9
SYMATTR Value 1n
SYMBOL res -208 -64 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R17
SYMATTR Value 1
SYMBOL cap 1168 -80 R0
SYMATTR InstName C16
SYMATTR Value 174p
SYMBOL res 816 -128 R0
SYMATTR InstName R13
SYMATTR Value 20
TEXT 536 -328 Left 2 ;Stacked Hbridge output
TEXT 144 -216 Left 2 ;PWM modulator
TEXT -552 -296 Left 2 ;Type III compensator
TEXT -1352 -80 Left 2 !.param Iratio=4/1000
TEXT 584 -296 Left 2 !.param VM=30\n.param Nph=4\n.param pwm_delay=1.2u
TEXT 128 -184 Left 2 !.param Vramp=8
TEXT -1056 -664 Left 2 !.ac dec 1k 100 100k
TEXT -1048 -808 Left 2 !.param MODE=1
TEXT -1336 -144 Left 2 ;Current sensor\nand burden resistor
TEXT -328 -960 Left 2 !.param fc=20k\n.param G_fc={0.184}\n.param phaseboost=62\n \n.param K={(tan((phaseboost/4+45)*3.1416/180))**2}\n.param H_fc={1/G_fc}\n.param R1=3.3k\n \n.param C2={1/(2*3.1416*fc*H_fc*R1)}\n.param C1={C2*(K-1)}\n.param R2={sqrt(K)/(2*3.1416*fc*C1)}\n.param R3={R1/(K-1)}\n.param C3={1/(2*3.1416*fc*R3*sqrt(K))}
TEXT -232 48 Left 2 ;Perturbation for open loop gain
TEXT 1104 -264 Left 2 ;Load coil
TEXT 1088 -240 Left 2 !.param LG=273u\n.param RG=1
TEXT -1400 -456 Left 2 ;Reference input\nPerturbation for closed loop gain
TEXT -1000 -152 Left 2 ;Error amplifier
TEXT -1056 -640 Left 2 !;op dec 1k 100 1meg
TEXT -160 -1088 Left 2 ;The component values for the type III compensator are calculated automatically\nBased on the specified fc, G(fc), and phaseboost\nTo view the resulting component values, set simulation type to "DC op pnt" and run\nThe component values are given by the voltages of these sources
TEXT -1048 -1032 Left 2 ;To model AC transfer functions, use .ac simulation\nFor open loop measurement, set MODE=0\nTotal loop gain is -V(Loopout)/V(Loopin)\nPlant gain G is V(Y)/V(U)\nCompensator gain H is V(Loopout)/V(Y)\nFor closed loop measurement, set MODE=1\nClosed loop gain is V(Y)
TEXT -1048 -616 Left 2 !;ac dec 1k 100 100k
TEXT -1040 -576 Left 2 !;tran 0 1m 0 1u
